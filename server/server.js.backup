import express from "express";
import cors from "cors";
import { AccessToken } from "livekit-server-sdk";
import { WebSocketServer } from "ws";
import { spawn } from "child_process";
import { createServer } from "http";

const app = express();
app.use(cors());

// For local demo. If you want other devices on your LAN to access,
// replace 127.0.0.1 with your machine LAN IP in the frontend or serverHost variable.
const serverHost = "http://192.168.124.5"; // change to http://192.168.x.x if needed
const rtmpBase = "rtmp://192.168.124.5/live";

app.get("/url", (req, res) => {
  const role = req.query.role || "doctor";
  const streamKey = role === "doctor" ? "doctorStream" : "patientStream";

  const pushUrl = `${rtmpBase}/${streamKey}`;
  // mediamtx serves FLV at http://host:8889/live/<streamKey>.flv
  const playUrl = `${serverHost}:8889/live/${streamKey}.flv`;

  res.json({
    role,
    pushUrl,
    playUrl,
  });
});

app.get("/token", async (req, res) => {
  try {
    const room = req.query.room || "demo";
    const identity = req.query.identity || "doctor";
    const role = req.query.role || "doctor";

    const at = new AccessToken("DEVKEY123", "SECRET123", { identity });
    const grant = {
      room,
      roomJoin: true,
      canPublish: true,
      canSubscribe: true,
      canPublishData: true,
    };
    at.addGrant(grant);

    const jwt = await at.toJwt();
    res.json({ token: jwt });
  } catch (e) {
    console.error("token generation error:", e);
    res.status(500).json({ error: "token_generation_failed" });
  }
});

const PORT = 3000;
const server = createServer(app);

// WebSocket æœåŠ¡å™¨ï¼Œç”¨äºæ¥æ”¶æµè§ˆå™¨æ¨æµå¹¶è½¬å‘åˆ° MediaMTX
const wss = new WebSocketServer({ server, path: "/stream" });

wss.on("connection", (ws) => {
  console.log("ğŸ”µ æ–°çš„ WebSocket è¿æ¥å»ºç«‹");

  // ä½¿ç”¨ ffmpeg å°† WebM æµè½¬æ¢ä¸º RTMP æ¨é€åˆ° MediaMTX
  const ffmpeg = spawn("ffmpeg", [
    "-i", "pipe:0",           // ä» stdin è¯»å–
    "-c:v", "libx264",        // è§†é¢‘ç¼–ç å™¨
    "-preset", "ultrafast",   // ç¼–ç é€Ÿåº¦
    "-tune", "zerolatency",   // ä½å»¶è¿Ÿ
    "-c:a", "aac",            // éŸ³é¢‘ç¼–ç å™¨
    "-f", "flv",              // è¾“å‡ºæ ¼å¼
    `${rtmpBase}/doctorStream` // RTMP æ¨æµåœ°å€
  ]);

  ffmpeg.on("error", (err) => {
    console.error("âŒ FFmpeg é”™è¯¯:", err);
  });

  ffmpeg.stderr.on("data", (data) => {
    // FFmpeg æ—¥å¿—ï¼ˆå¯é€‰ï¼‰
    // console.log(`FFmpeg: ${data}`);
  });

  ffmpeg.on("close", (code) => {
    console.log(`ğŸ”´ FFmpeg è¿›ç¨‹é€€å‡ºï¼Œé€€å‡ºç : ${code}`);
  });

  ws.on("message", (data) => {
    // å°†æµè§ˆå™¨å‘é€çš„ WebM æ•°æ®å†™å…¥ FFmpeg stdin
    if (ffmpeg.stdin.writable) {
      ffmpeg.stdin.write(data);
    }
  });

  ws.on("close", () => {
    console.log("ğŸ”´ WebSocket è¿æ¥å…³é—­");
    ffmpeg.stdin.end();
    ffmpeg.kill();
  });

  ws.on("error", (error) => {
    console.error("âŒ WebSocket é”™è¯¯:", error);
    ffmpeg.kill();
  });
});

server.listen(PORT, () => {
  console.log(`âœ… API æœåŠ¡å·²å¯åŠ¨ï¼šhttp://localhost:${PORT}`);
  console.log(`âœ… WebSocket æ¨æµæœåŠ¡å·²å¯åŠ¨ï¼šws://localhost:${PORT}/stream`);
});
